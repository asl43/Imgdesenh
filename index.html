<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Artístico - Foto/Vídeo para Arte</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #4ecdc4;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .input-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            border: 3px dashed #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .input-card:hover {
            border-color: #4ecdc4;
            background: #f0fdfc;
            transform: translateY(-5px);
        }

        .input-card.active {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .input-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .input-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #fileInput,
        #cameraInput,
        #videoInput {
            display: none;
        }

        .paste-area {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin: 15px 0;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .paste-area.drag-over {
            border-color: #4ecdc4;
            background: #f0fdfc;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-item label {
            font-weight: 600;
            color: #555;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
        }

        .filter-categories {
            margin: 30px 0;
        }

        .filter-category {
            margin-bottom: 25px;
        }

        .filter-category h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
            padding: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border-radius: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid #4ecdc4;
            background: white;
            color: #4ecdc4;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9em;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #4ecdc4;
            color: white;
            transform: scale(1.05);
        }

        .animation-controls {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .animation-controls h4 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .animation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .anim-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .anim-btn:hover,
        .anim-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.05);
        }

        .canvas-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .canvas-wrapper {
            text-align: center;
        }

        .canvas-wrapper h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }

        canvas,
        video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #fff;
        }

        .video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .video-container video {
            max-width: 48%;
        }

        .video-controls {
            margin-top: 20px;
            text-align: center;
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
        }

        .download-btn {
            background: white;
            color: #667eea;
            font-size: 1.1em;
            padding: 15px 30px;
            margin: 0 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
            width: 0%;
            transition: width 0.3s ease;
        }

        #cameraModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }

        #cameraModal .content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        #cameraModal video {
            max-width: 80vw;
            max-height: 60vh;
            border-radius: 10px;
        }

        #cameraModal .controls {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .canvas-container {
                grid-template-columns: 1fr;
            }

            .control-group {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 Studio Artístico Pro</h1>
            <p>Transforme fotos e vídeos em obras de arte com animações incríveis</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="image">📸 Imagens</div>
            <div class="tab" data-tab="video">🎬 Vídeos</div>
            <div class="tab" data-tab="animation">✨ Animações</div>
        </div>

        <div class="tab-content active" id="image-tab">
            <div class="input-section">
                <div class="input-card" id="uploadCard">
                    <h3>📁 Upload de Arquivo</h3>
                    <p>Selecione uma imagem do seu dispositivo</p>
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Escolher Arquivo
                    </button>
                    <input type="file" id="fileInput" accept="image/*">
                </div>

                <div class="input-card" id="pasteCard">
                    <h3>📋 Colar Imagem</h3>
                    <p>Cole uma imagem da área de transferência</p>
                    <div class="paste-area" id="pasteArea">
                        <span>Clique aqui e cole (Ctrl+V)</span>
                    </div>
                </div>

                <div class="input-card" id="cameraCard">
                    <h3>📸 Tirar Foto</h3>
                    <p>Use a câmera do seu dispositivo</p>
                    <button class="btn" onclick="app.startCamera()">
                        Abrir Câmera
                    </button>
                </div>
            </div>

            <div class="controls" id="controls" style="display: none;">
                <h3>🎛️ Controles de Estilo</h3>

                <div class="control-group">
                    <div class="control-item">
                        <label>Intensidade do Efeito: <span id="intensityValue">70</span>%</label>
                        <input type="range" id="intensity" class="slider" min="0" max="100" value="70">
                    </div>

                    <div class="control-item">
                        <label>Detalhamento: <span id="detailValue">50</span>%</label>
                        <input type="range" id="detail" class="slider" min="0" max="100" value="50">
                    </div>

                    <div class="control-item">
                        <label>Contraste: <span id="contrastValue">120</span>%</label>
                        <input type="range" id="contrast" class="slider" min="0" max="200" value="120">
                    </div>

                    <div class="control-item">
                        <label>Suavização: <span id="smoothValue">3</span></label>
                        <input type="range" id="smooth" class="slider" min="0" max="10" value="3">
                    </div>
                </div>

                <div class="filter-categories">
                    <div class="filter-category">
                        <h4>🎨 Desenhos Realistas</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="pencil-realistic">Lápis Realista</button>
                            <button class="filter-btn" data-filter="charcoal-detailed">Carvão Detalhado</button>
                            <button class="filter-btn" data-filter="graphite">Grafite</button>
                            <button class="filter-btn" data-filter="crosshatch">Hachura Cruzada</button>
                        </div>
                    </div>

                    <div class="filter-category">
                        <h4>🖼️ Estilos Artísticos</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="sketch-artistic">Esboço Artístico</button>
                            <button class="filter-btn" data-filter="ink-drawing">Desenho à Tinta</button>
                            <button class="filter-btn" data-filter="manga">Estilo Mangá</button>
                            <button class="filter-btn" data-filter="comic">Quadrinhos</button>
                        </div>
                    </div>

                    <div class="filter-category">
                        <h4>🎭 Efeitos Especiais</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="neon-sketch">Neon Sketch</button>
                            <button class="filter-btn" data-filter="vintage-drawing">Vintage</button>
                            <button class="filter-btn" data-filter="blueprint">Blueprint</button>
                            <button class="filter-btn" data-filter="chalk">Giz</button>
                        </div>
                    </div>

                    <div class="filter-category">
                        <h4>🌈 Pinturas</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="watercolor-advanced">Aquarela Pro</button>
                            <button class="filter-btn" data-filter="oil-painting">Pintura a Óleo</button>
                            <button class="filter-btn" data-filter="acrylic">Tinta Acrílica</button>
                            <button class="filter-btn" data-filter="impressionist">Impressionista</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando sua imagem...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="canvas-container" id="canvasContainer" style="display: none;">
                <div class="canvas-wrapper">
                    <h4>📷 Imagem Original</h4>
                    <canvas id="originalCanvas"></canvas>
                </div>
                <div class="canvas-wrapper">
                    <h4>🎨 Resultado</h4>
                    <canvas id="resultCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-content" id="video-tab">
            <div class="input-section">
                <div class="input-card">
                    <h3>🎬 Upload de Vídeo</h3>
                    <p>Selecione um vídeo para transformar em arte</p>
                    <button class="btn" onclick="document.getElementById('videoInput').click()">
                        Escolher Vídeo
                    </button>
                    <input type="file" id="videoInput" accept="video/*">
                </div>

                <div class="input-card">
                    <h3>📹 Gravar Vídeo</h3>
                    <p>Grave um vídeo usando sua câmera</p>
                    <button class="btn" onclick="app.startVideoRecording()">
                        Gravar Vídeo
                    </button>
                </div>
            </div>

            <div class="video-container" id="videoContainer" style="display: none;">
                <video id="originalVideo" controls></video>
                <video id="processedVideo" controls></video>
            </div>
            <div class="video-controls" id="videoControls" style="display: none;">
                <button class="btn" id="processVideoBtn">🎨 Processar Vídeo</button>
                <button class="btn" id="downloadVideoBtn" style="display: none;">💾 Baixar Vídeo</button>
            </div>
        </div>

        <div class="tab-content" id="animation-tab">
            <div class="animation-controls">
                <h4>✨ Criador de Animações Artísticas</h4>
                <div class="animation-buttons">
                    <button class="anim-btn active" data-animation="morph">🔄 Morphing</button>
                    <button class="anim-btn" data-animation="sketch-reveal">✏️ Desenho Aparecendo</button>
                    <button class="anim-btn" data-animation="color-flow">🌈 Fluxo de Cores</button>
                    <button class="anim-btn" data-animation="particle-draw">✨ Partículas</button>
                    <button class="anim-btn" data-animation="line-art">📏 Arte Linear</button>
                    <button class="anim-btn" data-animation="watercolor-bloom">🎨 Aquarela Fluindo</button>
                </div>

                <div class="control-group">
                    <div class="control-item">
                        <label>Velocidade: <span id="speedValue">1</span>x</label>
                        <input type="range" id="animSpeed" class="slider" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div class="control-item">
                        <label>Duração: <span id="durationValue">5</span>s</label>
                        <input type="range" id="animDuration" class="slider" min="1" max="15" value="5">
                    </div>
                </div>
            </div>

            <div class="canvas-container" id="animationCanvas" style="display: none;">
                <div class="canvas-wrapper">
                    <h4>🎬 Animação</h4>
                    <canvas id="animCanvas" width="600" height="400"></canvas>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="app.playAnimation()">▶️ Play</button>
                        <button class="btn" onclick="app.pauseAnimation()">⏸️ Pause</button>
                        <button class="btn" onclick="app.resetAnimation()">🔄 Reset</button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <h4>⚙️ Preview</h4>
                    <canvas id="previewCanvas" width="600" height="400"></canvas>
                </div>
            </div>
        </div>

        <div class="download-section" id="downloadSection" style="display: none;">
            <button class="btn download-btn" onclick="app.downloadResult()">
                💾 Baixar Resultado
            </button>
            <button class="btn download-btn" onclick="app.shareResult()">
                📤 Compartilhar
            </button>
            <button class="btn download-btn" onclick="app.createGIF()" id="gifBtn">
                🎞️ Criar GIF
            </button>
        </div>

        <div id="cameraModal">
            <div class="content">
                <video id="cameraVideo" autoplay></video>
                <div class="controls">
                    <button class="btn" id="captureBtn">📸 Capturar</button>
                    <button class="btn" id="recordBtn">🎬 Gravar</button>
                    <button class="btn" id="closeCameraBtn" style="background: #ff4757;">❌ Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ArtStudioApp {
            constructor() {
                this.originalCanvas = document.getElementById('originalCanvas');
                this.resultCanvas = document.getElementById('resultCanvas');
                this.animCanvas = document.getElementById('animCanvas');
                this.previewCanvas = document.getElementById('previewCanvas');
                this.originalCtx = this.originalCanvas.getContext('2d');
                this.resultCtx = this.resultCanvas.getContext('2d');
                this.animCtx = this.animCanvas.getContext('2d');
                this.previewCtx = this.previewCanvas.getContext('2d');

                this.currentImage = null;
                this.currentFilter = 'pencil-realistic';
                this.currentAnimation = 'morph';
                this.cameraStream = null;
                this.isRecording = false;
                this.mediaRecorder = null;
                this.animationFrame = null;
                this.animationProgress = 0;
                this.isAnimating = false;

                this.initializeEvents();
            }

            initializeEvents() {
                // Tab functionality
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Image inputs
                document.getElementById('fileInput').addEventListener('change', (e) => this.loadImageFromFile(e));
                document.getElementById('pasteArea').addEventListener('paste', (e) => this.loadImageFromPaste(e));
                document.getElementById('pasteArea').addEventListener('dragover', (e) => this.handleDragOver(e));
                document.getElementById('pasteArea').addEventListener('dragleave', (e) => this.handleDragLeave(e));
                document.getElementById('pasteArea').addEventListener('drop', (e) => this.handleDrop(e));

                // Camera controls
                document.getElementById('captureBtn').addEventListener('click', () => this.capturePhoto());
                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
                document.getElementById('closeCameraBtn').addEventListener('click', () => this.closeCamera());

                // Video inputs
                document.getElementById('videoInput').addEventListener('change', (e) => this.loadVideo(e.target.files[0]));
                document.getElementById('processVideoBtn').addEventListener('click', () => this.processVideo());
                document.getElementById('downloadVideoBtn').addEventListener('click', () => this.downloadVideo());

                // Sliders
                document.querySelectorAll('.slider').forEach(slider => {
                    slider.addEventListener('input', () => this.updateSliderValue(slider));
                    slider.addEventListener('change', () => this.applyFilter());
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.setFilter(btn));
                });

                // Animation buttons
                document.querySelectorAll('.anim-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.setAnimation(btn));
                });

                // Download/Share buttons
                document.getElementById('downloadSection').addEventListener('click', (e) => {
                    if (e.target.classList.contains('download-btn')) {
                        if (e.target.textContent.includes('Baixar')) {
                            this.downloadResult();
                        } else if (e.target.textContent.includes('Compartilhar')) {
                            this.shareResult();
                        } else if (e.target.textContent.includes('GIF')) {
                            this.createGIF();
                        }
                    }
                });

                // Initial setup
                this.updateSliderValue(document.getElementById('intensity'));
                this.updateSliderValue(document.getElementById('detail'));
                this.updateSliderValue(document.getElementById('contrast'));
                this.updateSliderValue(document.getElementById('smooth'));
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId + '-tab').classList.add('active');
                this.resetUI();
            }

            resetUI() {
                document.getElementById('controls').style.display = 'none';
                document.getElementById('canvasContainer').style.display = 'none';
                document.getElementById('downloadSection').style.display = 'none';
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('videoControls').style.display = 'none';
                document.getElementById('animationCanvas').style.display = 'none';
                this.pauseAnimation();
                this.currentImage = null;
            }

            // Image loading
            loadImageFromFile(e) {
                if (e.target.files && e.target.files[0]) {
                    this.loadImage(e.target.files[0]);
                }
            }

            loadImageFromPaste(e) {
                e.preventDefault();
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        this.loadImage(item.getAsFile());
                        break;
                    }
                }
            }

            loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.currentImage = img;
                        this.displayImage();
                        document.getElementById('controls').style.display = 'block';
                        document.getElementById('canvasContainer').style.display = 'grid';
                        document.getElementById('downloadSection').style.display = 'flex';
                        this.applyFilter();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            displayImage() {
                if (!this.currentImage) return;

                const maxWidth = 500;
                const maxHeight = 400;
                let {
                    width,
                    height
                } = this.currentImage;

                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }

                this.originalCanvas.width = this.resultCanvas.width = width;
                this.originalCanvas.height = this.resultCanvas.height = height;
                this.originalCtx.drawImage(this.currentImage, 0, 0, width, height);
            }

            // Camera/Video
            startCamera() {
                navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment'
                        }
                    })
                    .then(stream => {
                        this.cameraStream = stream;
                        const video = document.getElementById('cameraVideo');
                        video.srcObject = stream;
                        document.getElementById('cameraModal').style.display = 'block';
                        document.getElementById('recordBtn').style.display = 'none';
                    })
                    .catch(err => alert('Erro ao acessar a câmera: ' + err.message));
            }

            startVideoRecording() {
                navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    })
                    .then(stream => {
                        this.cameraStream = stream;
                        const video = document.getElementById('cameraVideo');
                        video.srcObject = stream;
                        document.getElementById('cameraModal').style.display = 'block';
                        document.getElementById('recordBtn').style.display = 'inline-block';
                    })
                    .catch(err => alert('Erro ao acessar a câmera: ' + err.message));
            }

            capturePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                canvas.toBlob(blob => this.loadImage(blob));
                this.closeCamera();
            }

            toggleRecording() {
                const recordBtn = document.getElementById('recordBtn');
                if (!this.isRecording) {
                    this.mediaRecorder = new MediaRecorder(this.cameraStream);
                    const chunks = [];
                    this.mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, {
                            type: 'video/webm'
                        });
                        this.loadVideo(blob);
                    };
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    recordBtn.textContent = '⏹️ Parar';
                } else {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    recordBtn.textContent = '🎬 Gravar';
                }
            }

            closeCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                document.getElementById('cameraModal').style.display = 'none';
                this.isRecording = false;
                document.getElementById('recordBtn').textContent = '🎬 Gravar';
            }

            loadVideo(file) {
                const video = document.getElementById('originalVideo');
                const url = URL.createObjectURL(file);
                video.src = url;
                video.load();
                document.getElementById('videoContainer').style.display = 'flex';
                document.getElementById('videoControls').style.display = 'block';
            }

            processVideo() {
                // Future implementation using WebCodecs/Web Workers for better performance
                alert("O processamento de vídeo está em desenvolvimento. Esta funcionalidade será otimizada com WebCodecs para maior desempenho.");
            }

            // Filter & Animation Logic
            updateSliderValue(slider) {
                document.getElementById(slider.id + 'Value').textContent = slider.value;
            }

            setFilter(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.currentFilter = btn.dataset.filter;
                this.applyFilter();
            }

            setAnimation(btn) {
                document.querySelectorAll('.anim-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.currentAnimation = btn.dataset.animation;
                this.resetAnimation();
                document.getElementById('animationCanvas').style.display = 'grid';
            }

            applyFilter() {
                if (!this.currentImage) return;

                document.getElementById('loading').style.display = 'block';
                this.simulateProgress();

                const intensity = document.getElementById('intensity').value / 100;
                const detail = document.getElementById('detail').value / 100;
                const smooth = document.getElementById('smooth').value;
                const contrast = document.getElementById('contrast').value;

                // Use setTimeout to allow the UI to update the loading state
                setTimeout(() => {
                    this.resultCtx.clearRect(0, 0, this.resultCanvas.width, this.resultCanvas.height);
                    this.resultCtx.filter = `contrast(${contrast}%) blur(${smooth * 0.3}px)`;
                    this.resultCtx.drawImage(this.originalCanvas, 0, 0);

                    const imageData = this.resultCtx.getImageData(0, 0, this.resultCanvas.width, this.resultCanvas.height);
                    const filteredData = this.applyAdvancedFilter(imageData, this.currentFilter, intensity, detail);

                    this.resultCtx.filter = 'none';
                    this.resultCtx.putImageData(filteredData, 0, 0);

                    document.getElementById('loading').style.display = 'none';
                }, 100);
            }

            applyAdvancedFilter(imageData, filterType, intensity, detail) {
                // Modularized filter logic
                const data = imageData.data;
                const newData = new Uint8ClampedArray(data);
                const width = imageData.width;

                for (let i = 0; i < data.length; i += 4) {
                    const x = (i / 4) % width;
                    const y = Math.floor((i / 4) / width);
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const gray = r * 0.299 + g * 0.587 + b * 0.114;

                    let resultR = r,
                        resultG = g,
                        resultB = b;

                    switch (filterType) {
                        case 'pencil-realistic':
                            const edgeStrength = x > 0 && y > 0 && x < width - 1 ? Math.abs(gray - (data[i - width * 4] * 0.299 + data[i - width * 4 + 1] * 0.587 + data[i - width * 4 + 2] * 0.114)) + Math.abs(gray - (data[i - 4] * 0.299 + data[i - 3] * 0.587 + data[i - 2] * 0.114)) : 0;
                            const texture = Math.random() * 20 - 10;
                            const pencilGray = gray - (edgeStrength * detail * 0.5) + texture;
                            const finalGray = gray + (pencilGray - gray) * intensity;
                            resultR = resultG = resultB = finalGray;
                            break;
                        case 'charcoal-detailed':
                            const charcoal = Math.pow(gray / 255, 1.5 + detail) * 255;
                            const charcoalTexture = (Math.random() - 0.5) * 30 * detail;
                            const finalCharcoal = charcoal + charcoalTexture;
                            resultR = resultG = resultB = gray + (finalCharcoal - gray) * intensity;
                            break;
                        case 'graphite':
                            const graphite = Math.pow(gray / 255, 0.8) * 255;
                            const smoothTexture = Math.sin(gray * 0.1) * 5 * detail;
                            resultR = resultG = resultB = gray + (graphite + smoothTexture - gray) * intensity;
                            break;
                        case 'crosshatch':
                            const hatch1 = Math.sin(x * 0.05 + y * 0.05) > (gray / 255 - 0.5) * 2 ? 255 : 0;
                            const hatch2 = Math.sin(x * 0.05 - y * 0.05) > (gray / 255 - 0.5) * 2 ? 255 : 0;
                            const crosshatch = Math.min(hatch1, hatch2);
                            resultR = resultG = resultB = gray + (crosshatch - gray) * intensity * detail;
                            break;
                        case 'sketch-artistic':
                            const sketchGray = 255 - gray;
                            const sketchResult = gray + (sketchGray - gray) * intensity;
                            resultR = resultG = resultB = sketchResult;
                            break;
                        case 'ink-drawing':
                            const threshold = 128 + (detail - 0.5) * 100;
                            const ink = gray > threshold ? 255 : 0;
                            resultR = resultG = resultB = gray + (ink - gray) * intensity;
                            break;
                        case 'manga':
                            const levels = Math.floor(3 + detail * 5);
                            const quantized = Math.floor(gray / (255 / levels)) * (255 / levels);
                            resultR = resultG = resultB = gray + (quantized - gray) * intensity;
                            break;
                        case 'comic':
                            resultR = r > 128 ? 255 : 0;
                            resultG = g > 128 ? 255 : 0;
                            resultB = b > 128 ? 255 : 0;
                            break;
                        case 'neon-sketch':
                            const edge = x > 0 && y > 0 && x < width - 1 ? Math.abs(gray - (data[i - width * 4] * 0.299 + data[i - width * 4 + 1] * 0.587 + data[i - width * 4 + 2] * 0.114)) + Math.abs(gray - (data[i - 4] * 0.299 + data[i - 3] * 0.587 + data[i - 2] * 0.114)) : 0;
                            if (edge > 20 * detail) {
                                resultR = 0 + edge * intensity;
                                resultG = 255 * intensity;
                                resultB = 255 * intensity;
                            } else {
                                const dark = gray * 0.1;
                                resultR = resultG = resultB = dark;
                            }
                            break;
                        case 'vintage-drawing':
                            resultR = r * 0.9;
                            resultG = g * 0.8;
                            resultB = b * 0.7;
                            break;
                        case 'blueprint':
                            const inverted = 255 - gray;
                            resultR = 20 + inverted * intensity * 0.3;
                            resultG = 50 + inverted * intensity * 0.5;
                            resultB = 150 + inverted * intensity * 0.8;
                            break;
                        case 'chalk':
                            const chalkTexture = (Math.random() - 0.5) * 50 * detail;
                            resultR = resultG = resultB = gray + chalkTexture;
                            break;
                        case 'watercolor-advanced':
                            const bleeding = Math.random() * 30 * detail;
                            const transparency = 0.7 + Math.random() * 0.3 * intensity;
                            resultR = r + bleeding - 15;
                            resultG = g + bleeding - 10;
                            resultB = b + bleeding - 5;
                            newData[i + 3] = data[i + 3] * transparency;
                            break;
                        case 'oil-painting':
                            const oilBlur = detail * 5;
                            resultR = r * 0.9 + Math.random() * 20;
                            resultG = g * 0.9 + Math.random() * 20;
                            resultB = b * 0.9 + Math.random() * 20;
                            break;
                        case 'acrylic':
                            const acrylicTexture = (Math.random() - 0.5) * 40 * detail;
                            resultR = r + acrylicTexture;
                            resultG = g + acrylicTexture;
                            resultB = b + acrylicTexture;
                            break;
                        case 'impressionist':
                            const impressionistTexture = (Math.random() - 0.5) * 60 * detail;
                            resultR = r + impressionistTexture;
                            resultG = g + impressionistTexture;
                            resultB = b + impressionistTexture;
                            break;
                    }

                    newData[i] = Math.max(0, Math.min(255, resultR));
                    newData[i + 1] = Math.max(0, Math.min(255, resultG));
                    newData[i + 2] = Math.max(0, Math.min(255, resultB));
                }
                return new ImageData(newData, imageData.width, imageData.height);
            }

            simulateProgress() {
                const progressFill = document.getElementById('progressFill');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                    }
                    progressFill.style.width = progress + '%';
                }, 50);
            }

            // Animations
            playAnimation() {
                if (!this.currentImage) return;
                this.isAnimating = true;
                this.animationProgress = 0;
                this.animCanvas.width = this.currentImage.width;
                this.animCanvas.height = this.currentImage.height;
                this.animateFrame();
            }

            animateFrame() {
                if (!this.isAnimating) return;
                const speed = document.getElementById('animSpeed').value;
                const duration = document.getElementById('animDuration').value;
                this.animationProgress += (speed * 0.01) / duration;
                if (this.animationProgress >= 1) {
                    this.animationProgress = 0;
                }

                this.animCtx.clearRect(0, 0, this.animCanvas.width, this.animCanvas.height);
                this.drawAnimation();
                this.animationFrame = requestAnimationFrame(() => this.animateFrame());
            }

            drawAnimation() {
                const prog = this.animationProgress;
                const img = this.currentImage;
                const animCtx = this.animCtx;

                switch (this.currentAnimation) {
                    case 'morph':
                        const morphAmt = (Math.sin(prog * Math.PI * 2) + 1) / 2;
                        animCtx.globalAlpha = 1 - morphAmt;
                        animCtx.drawImage(this.originalCanvas, 0, 0);
                        animCtx.globalAlpha = morphAmt;
                        animCtx.drawImage(this.resultCanvas, 0, 0);
                        break;
                    case 'sketch-reveal':
                        animCtx.globalAlpha = 0.3;
                        animCtx.drawImage(img, 0, 0);
                        animCtx.globalAlpha = 1;
                        animCtx.strokeStyle = '#333';
                        animCtx.lineWidth = 2;
                        const lines = Math.floor(prog * 100);
                        for (let i = 0; i < lines; i++) {
                            const x = Math.random() * animCtx.canvas.width;
                            const y = Math.random() * animCtx.canvas.height;
                            const length = 20 + Math.random() * 30;
                            const angle = Math.random() * Math.PI * 2;
                            animCtx.beginPath();
                            animCtx.moveTo(x, y);
                            animCtx.lineTo(x + Math.cos(angle) * length, y + Math.sin(angle) * length);
                            animCtx.stroke();
                        }
                        break;
                    case 'color-flow':
                        const imageData = this.originalCtx.getImageData(0, 0, img.width, img.height);
                        const newData = new Uint8ClampedArray(imageData.data);
                        for (let i = 0; i < newData.length; i += 4) {
                            const wave = Math.sin(prog * Math.PI * 4 + i * 0.01);
                            newData[i] += wave * 50;
                            newData[i + 1] += Math.cos(prog * Math.PI * 3 + i * 0.01) * 30;
                            newData[i + 2] += Math.sin(prog * Math.PI * 5 + i * 0.01) * 40;
                        }
                        animCtx.putImageData(new ImageData(newData, imageData.width, imageData.height), 0, 0);
                        break;
                    case 'particle-draw':
                        animCtx.drawImage(img, 0, 0);
                        const particles = 50;
                        for (let i = 0; i < particles; i++) {
                            const angle = prog * Math.PI * 2 + i * 0.1;
                            const x = animCtx.canvas.width / 2 + Math.cos(angle) * (50 + i * 5);
                            const y = animCtx.canvas.height / 2 + Math.sin(angle) * (30 + i * 3);
                            animCtx.fillStyle = `hsl(${i * 10 + prog * 360}, 70%, 60%)`;
                            animCtx.beginPath();
                            animCtx.arc(x, y, 3, 0, Math.PI * 2);
                            animCtx.fill();
                        }
                        break;
                    case 'line-art':
                        animCtx.strokeStyle = '#000';
                        animCtx.lineWidth = 1;
                        const totalLines = 200;
                        const currentLines = Math.floor(prog * totalLines);
                        for (let i = 0; i < currentLines; i++) {
                            const p = i / totalLines;
                            const x = p * animCtx.canvas.width;
                            const y = Math.sin(p * Math.PI * 8 + prog * Math.PI * 2) * 50 + animCtx.canvas.height / 2;
                            if (i === 0) animCtx.beginPath();
                            animCtx.lineTo(x, y);
                        }
                        animCtx.stroke();
                        break;
                    case 'watercolor-bloom':
                        animCtx.drawImage(img, 0, 0);
                        const blooms = 20;
                        for (let i = 0; i < blooms; i++) {
                            const size = (prog + i * 0.1) * 100;
                            const x = (i % 5) * (animCtx.canvas.width / 5) + animCtx.canvas.width / 10;
                            const y = Math.floor(i / 5) * (animCtx.canvas.height / 4) + animCtx.canvas.height / 8;
                            const gradient = animCtx.createRadialGradient(x, y, 0, x, y, size);
                            gradient.addColorStop(0, `hsla(${i * 30}, 70%, 60%, 0.3)`);
                            gradient.addColorStop(1, `hsla(${i * 30}, 70%, 60%, 0)`);
                            animCtx.fillStyle = gradient;
                            animCtx.beginPath();
                            animCtx.arc(x, y, size, 0, Math.PI * 2);
                            animCtx.fill();
                        }
                        break;
                }
            }

            pauseAnimation() {
                this.isAnimating = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
            }

            resetAnimation() {
                this.pauseAnimation();
                this.animationProgress = 0;
                this.animCtx.clearRect(0, 0, this.animCanvas.width, this.animCanvas.height);
            }

            // Download & Share
            downloadResult() {
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                const link = document.createElement('a');
                if (activeTab === 'image') {
                    link.download = `arte-${this.currentFilter}-${Date.now()}.png`;
                    link.href = this.resultCanvas.toDataURL();
                } else if (activeTab === 'animation') {
                    link.download = `animacao-${this.currentAnimation}-${Date.now()}.png`;
                    link.href = this.animCanvas.toDataURL();
                }
                link.click();
            }

            shareResult() {
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                const canvas = activeTab === 'image' ? this.resultCanvas : this.animCanvas;
                if (navigator.share) {
                    canvas.toBlob(blob => {
                        const file = new File([blob], `arte-${Date.now()}.png`, {
                            type: 'image/png'
                        });
                        navigator.share({
                            title: 'Minha arte criada no Studio Artístico',
                            files: [file]
                        });
                    });
                } else {
                    canvas.toBlob(blob => {
                        navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]).then(() => {
                            alert('Arte copiada para a área de transferência!');
                        }).catch(err => {
                            alert('Não foi possível copiar a imagem: ' + err);
                        });
                    });
                }
            }

            createGIF() {
                alert('Funcionalidade de GIF em desenvolvimento! Por enquanto, você pode usar as animações em tempo real.');
            }

            downloadVideo() {
                const processedVideo = document.getElementById('processedVideo');
                if (!processedVideo.src) return;
                const link = document.createElement('a');
                link.download = `video-artistico-${Date.now()}.webm`;
                link.href = processedVideo.src;
                link.click();
            }

            // Drag and Drop helpers
            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('pasteArea').classList.add('drag-over');
            }

            handleDragLeave() {
                document.getElementById('pasteArea').classList.remove('drag-over');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('pasteArea').classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    this.loadImage(files[0]);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new ArtStudioApp();
        });
    </script>
</body>
</html>
